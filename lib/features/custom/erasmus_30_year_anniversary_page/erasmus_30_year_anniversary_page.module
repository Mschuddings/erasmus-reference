<?php
/**
 * @file
 * Code for the Erasmus+ 30 year anniversary: Page feature.
 */

include_once 'erasmus_30_year_anniversary_page.features.inc';

/**
 * Implements hook_preprocess_page().
 */
function erasmus_30_year_anniversary_page_preprocess_page(&$vars) {
  if (isset($vars['node'])
      && $vars['node']->type == 'erasmus_30_year_anniversary_page'
      && isset($vars['node']->field_30ya_contentrow_media[$vars['node']->language][0])) {
    $top_media = $vars['node']->field_30ya_contentrow_media;
    $top_txt = $vars['node']->field_30ya_contentrow_richtext;

    $vars['page']['sidebar_left'] = $top_txt[$vars['node']->language][0]['value'];

    if (isset($top_media[$vars['language']->language][0]['file'])
        && $top_media[$vars['language']->language][0]['file']->type == 'video') {
      $item = file_view_file($top_media[$vars['language']->language][0]['file']);
      $item = render($item);
    }
    else {
      $file = $top_media[$vars['language']->language][0]['fid'];
      $file = file_load($file);
      $variables = array(
        'path' =>
        file_create_url($file->uri),
        'alt' => $vars['node']->title,
        'title' => $vars['node']->title,
      );
      $item = theme('image', $variables);
    }
    $vars['page']['sidebar_right'] = $item . render($vars['page']['sidebar_right']);
  }
}

/**
 * Implements hook_preprocess_node().
 */
function erasmus_30_year_anniversary_page_preprocess_node(&$vars) {
  if (isset($vars['content']['field_30ya_contentrow_media'])) {
    unset($vars['content']['field_30ya_contentrow_media']);
    unset($vars['content']['field_30ya_contentrow_richtext']);
  }
}

/**
 * Implements hook_theme().
 *
 * TODO Gives a lot of notices.
 */
function erasmus_30_year_anniversary_page_theme() {
  $array = [];
  $types = _erasmus_30_year_anniversary_page_get_types_field_collections();
  foreach ($types as $type) {
    $array['field_collection_item__' . $type] = [
      'variables' => array(
        'text' => NULL,
        'title_field' => NULL,
        'media' => NULL,
        'type' => NULL,
        'disable_auto_columns' => NULL,
      ),
      'template' => 'field-collection-item--' . str_replace('_', '-', $type),
      'path' => drupal_get_path('theme', 'erasmus_30year_anniversary') . '/templates/field-collection',
    ];
  }
  return $array;
}

/**
 * Get all of the field collection types.
 */
function _erasmus_30_year_anniversary_page_get_types_field_collections() {
  $types = [];
  $result = db_select('field_config', 'fc')
    ->fields('fc', ['data'])
    ->condition('field_name', 'field_30ya_contentrow_type')
    ->execute();
  foreach ($result as $res) {
    $data = $res->data;
    $data = unserialize($data);
    $allowed_values = $data['settings']['allowed_values'];
    foreach ($allowed_values as $key => $val) {
      $types[] = str_replace('-', '_', $key);
    }
  }
  return $types;
}
