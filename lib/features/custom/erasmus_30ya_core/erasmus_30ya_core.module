<?php
/**
 * @file
 * Code for the erasmus_30ya_core feature.
 */

/**
 * Implements hook_custom_theme().
 *
 * Switch to my theme when applicable.
 */
function erasmus_30ya_core_custom_theme() {
  $is_allowed = FALSE;

  $node = menu_get_object('node');
  $allowed_types = [
    'erasmus_30_year_anniversary_page',
    'erasmus_30_year_anniversary_pres',
    'erasmus_30_year_anniversary_stor',
    'erasmus_30ya_event',
    'erasmus_30_year_anniversary_part',
    'erasmus_30_year_anniversary_hero',
    'erasmus_30_year_anniversary_home',
  ];
  if (is_object($node) && isset($node->type)
      && in_array($node->type, $allowed_types)) {
    $is_allowed = TRUE;
  }

  $allowed_uris = [
    'events',
    'partners',
    'share-my-story',
    'press-releases',
    'discover-erasmusplus',
  ];
  $current_path = current_path();
  if (in_array($current_path, $allowed_uris)) {
    $is_allowed = TRUE;
  }
  // If you have more themes, update the code below.
  if ($is_allowed) {
    return 'erasmus_30year_anniversary';
  }
}

/**
 * Implements hook_context_load_alter().
 *
 * Unset context from other sites.
 */
function erasmus_30ya_core_context_load_alter(&$context) {
  switch ($context->name) {
    case 'site_wide';
      global $theme;
      if ($theme == 'erasmus_30year_anniversary') {
        $array_to_unset = [
          'om_maximenu-om-maximenu-1',
          'block-5',
        ];
        foreach ($array_to_unset as $unset) {
          unset($context->reactions['block']['blocks'][$unset]);
        }
      }
      break;

    case 'erasmus_30_years_anniversary_campaign_global':
      global $theme;
      if ($theme !== 'erasmus_30year_anniversary') {
        // Unset all the blocks for this context.
        unset($context->reactions['block']['blocks']);
      }
      break;

  }
}

/**
 * Implements hook_preprocess_node().
 */
function erasmus_30ya_core_preprocess_node(&$vars) {
  $allowed_views = [
    'erasmus_30_year_anniversary_events',
    'erasmus_30_year_anniversary_stories',
  ];
  if (isset($vars['view']->name)
      && in_array($vars['view']->name, $allowed_views)) {
    $vars['city'] = $vars['field_30ya_city'][0]['value'];
    $vars['country'] = $vars['field_30ya_country'][0]['taxonomy_term']->name;
    $vars['expected_participants']['number'] = $vars['field_30ya_expected_participants'][0]['value'];
    $vars['expected_participants']['title'] = t('Expected participants');
    $vars['link']['title'] = $vars['field_30ya_link'][0]['title'];
    $vars['link']['url'] = $vars['field_30ya_link'][0]['url'];
    $vars['organiser']['title'] = $vars['field_30ya_link_organiser'][0]['title'];
    $vars['organiser']['url'] = $vars['field_30ya_link_organiser'][0]['url'];
    $vars['intro'] = $vars['body'][0]['value'];
    $vars['date'] = $vars['field_30ya_txt_date'][0]['value'];
    $vars['sector'] = $vars['field_30ya_sector'][0]['value'];
    $vars['theme_hook_suggestions'][] = 'node__card';
  }
}

/**
 * Implements hook_menu().
 */
function erasmus_30ya_core_menu() {
  $items = array();

  $items['admin/settings/erasmus_30ya_core'] = array(
    'title' => 'Erasmus+ 30 year anniversary settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('erasmus_30ya_core_admin'),
    'file' => 'admin/erasmus_30ya_core.admin.inc',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}
